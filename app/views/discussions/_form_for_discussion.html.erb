<% form_reference_id = SecureRandom.urlsafe_base64 %>

<% if @active_edit == false %>
  <% @discussion=Discussion.new %>
<% end %>

<%= form_for(@discussion, remote: true, html: { class: "discussion-form-js", id: form_reference_id, data: { post_type: 'Discussion' } }) do |f| %> 
  <%= hidden_field_tag 'in_form', in_form%>
  <% if @discussion.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@discussion.errors.count, "error") %> prohibited this discussion from being saved:</h2>
      <ul>
      <% @discussion.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
  
  <% contents = @discussion.contents.build %>
  
  <div class="new-publication-form-content">

    <div class="form-group">
      <div class="form-group-label">
        <%= f.label :title, "Tema de la discusión: " %>
      </div>
      <div class="form-group-main">
        <div class="form-unit">
          <%= f.text_field :title, placeholder: 'Ejemplo: Números primos', minlength: 4, required: "required" %>
        </div>
      </div>
    </div>

    <div class="form-group">
      <div class="form-group-label">
        <%= f.label :description, "Descripción:" %>
      </div>
      <div class="form-group-main">
        <div class="form-unit">
          <%= f.text_area :description, placeholder: "Descripción", rows: 3, required: true, class: 'autogrow' %>
        </div>
      </div>
    </div>
    
    <% if @active_edit == false %>

      <div class="form-group ">
        <div class="form-group-label label-no-p">
          <%= f.label "", "Material de soporte:" %>
        </div>
        <div class="form-group-main">
          <div class="form-unit">
            <ul class="list-buttons left">
              <li>
                <a class="btn btn-secondary btn-small add-dropbox-content-js"><%= icon('dropbox-asset') %> Dropbox</a>
              </li>
              <li>
                <%= render partial: 'assets/upload_asset_button', locals: { from: 'discussion-create-form' } %>
              </li>
            </ul>
            <%= render partial: 'assets/support_material_container', locals: { from: 'discussion-create-form-assets' } %>
          </div>
        </div>
      </div>
      
      <% unless current_role == 'student' %>
        <div class="form-group">
          <div class="form-group-main">
            <div class="form-unit">
              <label>
                <%= f.check_box :evaluable, class: 'evaluable-fields-trigger-js' %> 
                Calificable
              </label>
            </div>
          </div>
        </div>

        <div class="evaluable-fields-js">
          <div class="form-group">
            <div class="form-group-label">
              <%= f.label 'Date', "Fechas:" %>
            </div>
            <div class="form-group-main">
              <div class="f-col f-col-5">
                <div class="form-unit">
                  <%= f.text_field :publish_date, placeholder: 'Día de publicación', class: "datetime-picker", value: '' %>
                </div>
              </div>

              <div class="f-col f-col-5">
                <div class="form-unit">
                  <%= f.text_field :end_date, placeholder: 'Fecha de entrega', class: "datetime-picker", value: '' %>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <div class="form-group-label label-no-p">
              <%= f.label '', "Criterios a evaluar:" %>
            </div>
            <div class="form-group-main">
              <div class="areas-of-evaluation">
                <div class="form-unit">
                  <div class="fields-wrap">
                    <div class="fields-group">
                      <%= f.fields_for :evaluation_criteria do | builder | %>
                        <%= render partial: "shared/evaluation_criteria/evaluation_criteria_fields", locals: { f: builder, base_model: @discussion } %>
                      <% end %>
                    </div>
                    <%= link_to_add_evaluation_criteria 'Agregar criterio', f, :evaluation_criteria %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

    <% end %>

  </div>

  <div class="new-publication-footer">
    <% if @active_edit == false %>
      <ul class="list-buttons right fr">
        <li>
          <%= link_to "Cancelar", "", class: "btn btn-secondary cancel-post-form_tab", onClick: 'removeSliderEvaluation();' %>
        </li>
        <li>
          <% if in_form != 'course'%>
            <%= render :partial => "shared/dropdown", :locals => { :hasPublic => true, :hasCourses => true, :hasGroups => true, :hasUser => true,:defaultText => 'Público', :default_icon => 'public-new-publication', :in_type => in_type } %>
          <%else%>
            <% courses = @discussion.courses.build %>
            <%= hidden_field_tag "delivery[course_ids][]", @course.id %>   
          <%end%>
        </li>
        <li>
          <span class="btn btn-primary input-btn activable">
            <%= f.submit "Crear Discusión", :id => 'comment-post-form', :class => "activable" %>
          </span>
        </li>
      </ul>
    <% else %>
      <ul class="list-buttons right">
        <li>
          <div class="btn btn-secondary cancel-edit-publication-js">Cancelar</div>
        </li>
        <li>
          <span class="btn btn-primary input-btn activable">
            <%= f.submit "Guardar discusión",  :class => "activable" %>
          </span>
        </li>
      </ul>
    <%end%>
  </div>
<% end %>
