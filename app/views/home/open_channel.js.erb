<% if @course_channel
	namePendingChannel = Course.find(@receiver_user_id).title
else
	namePendingChannel = User.find(@receiver_user_id).name
end %>

var panelsHolder = $('.chat-panels'),
		chatExpanded = $('#chat'),
		channel = "<%= @channel.channel_name %><%= @course_channel == true ? '?course=true' : ''%>",
		typeChannel = "<%= @course_channel == true ? 'course' : 'user' %>",
		channelExist = Chat.channelExistActive(channel);

// No esta en home/chat
if ( !chatExpanded.length && !channelExist ) {
	panelsHolder.append('<%= subscribe_to @channel_name %>');

	if ( Chat.activePanelsCount == Chat.availableSpots ) {
		if ( Chat.pendingPanelsCount == 0 ) {
			panelsHolder.append('<%= escape_javascript(render(:partial => '/shared/chat/go_to_chat', :locals => {:messages => @messages, :channel => @channel, :page => @page}))%>');
			Chat.moreReposition();
		};

		var pendingChannels = $.map( Chat.pendingPanelsChannels, function(item, index) {
			return Chat.pendingPanelsChannels[index].channel;
		});
	
		if ( !Chat.channelExistPending(channel) ) {
			Chat.pendingPanelsCount++;
			Chat.updatePendingConversations('<%= current_user.id %>');

			var dataChannel = {
				type: typeChannel,
				channel: channel,
				name: "<%= namePendingChannel %>",
				state: "pending"
			};

			Chat.pendingPanelsChannels.push( dataChannel );
			$.cookie( dataChannel.channel, JSON.stringify(dataChannel), { expires: 1, path: '/' });

			$('.pending-channels-list').append('<li data-channel="' +channel+ '" data-channel-type="' +typeChannel+ '" data-current-user-id="<%= current_user.id %>" onclick="Chat.switchPanel(this)"><%= namePendingChannel %></li>');
		};
	};

	if ( Chat.activePanelsCount < Chat.availableSpots ) {
		var currPanel;
		panelsHolder.append('<%= escape_javascript(render(:partial => '/shared/chat/conversation', :locals => {:messages => @messages, :channel => @channel, :page => @page, :receiver_user_id => @receiver_user_id, :course_conversation => @course_channel }))%>');

		currPanel = $('.chat-panel[data-panel-id="<%= @channel.id%>"]');

		currPanel.find('.chat-panel-main-content').scrollTop( currPanel.find('.chat-messages-container').prop('scrollHeight') + 30 );
		currPanel.find('input#mesage').focus();

		var dataChannel = {
			type: typeChannel,
			channel: channel,
			name: "<%= namePendingChannel %>",
			state: "expanded"
		};
		
		Chat.activePanelsChannels.push( dataChannel );
		Chat.addPanel( dataChannel );
	};
};

// Si estamos en el path del chat
if ( chatExpanded.length ) {
	if ( Chat.expandedPanelChannel != channel ) {
		Chat.expandedPanelChannel = channel;
		
		PrivatePub.unsubscribe("<%=@channel_name%>");
		panelsHolder.append('<%= subscribe_to @channel_name %>');
		$('#chat').html('<%= escape_javascript(render(:partial => '/shared/chat/chat', :locals => {:messages => @messages, :channel => @channel }))%>');

		var messagesTitle     = $('.chat-converstion-title'),
	      messagesContainer = $('.chat-main-container'),
	      messagesNewContainer = $('.chat-new-message');

	  messagesContainer.height( $(window).height() - $('.topbar').outerHeight() - messagesTitle.outerHeight() - messagesNewContainer.outerHeight() );
	  $('.chat-main-container').animate({ scrollTop: $('.load-more-messages-trigger').outerHeight() + $('#chat-messages').outerHeight() }, 500);
	};
};

// Ponemos a cero los mensajes del chat
$('#messages-notifications-count span').html(0);
PrivatePub.subscribe('<%= @channel.channel_name %>', function( data ) {
	var chatPanel 	= $('#chat-channel-'+ data.channel.id ),
			chatContent = chatPanel.find('.chat-panel-main-content');

	function append_new_message_tpl(element) {

		if(data.message.user_id != undefined) {
			if(data.sender.avatar != undefined) {
				var typeMsg 	= '',
						srcAvatar = '';

				if( data.sender.avatar.profile.url != null ) {
					srcAvatar = data.sender.avatar.head.url;
				} else {
					srcAvatar = '/assets/imagexx.png';
				}

				if(('' + <%= current_user.id %>) != ('' + data.message.user_id)) {
					typeMsg = 'message-received';
					avatar = '<div class="chat-message-author"><span class="avatar-holder"><img src="'+ srcAvatar +'"></span></div>';
				} else {
					avatar = ''
					typeMsg = 'message-sent';
				}
				
			  $('<div id ="message_'+ data.message.id +'" class="chat-message-item '+ typeMsg +'">' + avatar +
			  	'<div class="chat-message-main">' +
			  	'<span class="tip"></span><div class="chat-message-content">'+ data.message.mesage_html +'</div><span class="meta">' +moment(data.message.created_at).lang('es').format("DD [de] MMMM [del] YYYY [-] h:mm a")+ '</span></div></div>'
			  ).appendTo( element );
			}
		}
	}

	/* Si esta en /home/chat
  ----------------------------------*/
	if( $('#chat').length ) {
		var exist = $('[data-channel-id="' +data.channel.id+ '"]');
		if ( exist.length > 0 ) {
			append_new_message_tpl( $('#chat-messages') );
			$('.chat-main-container').animate({ scrollTop: $('.load-more-messages-trigger').outerHeight() + $('#chat-messages').outerHeight() }, 500);
		};
	};

	if( $('#chat-channel-' + data.channel.id).length ) {
		var chatPanel = $('#chat-channel-' + data.channel.id),
	    messagesContainer = chatPanel.find('.chat-zone div.chat-zone-messages');
		append_new_message_tpl( messagesContainer );
		chatPanel.find('.chat-panel-main-content').scrollTop( messagesContainer.prop('scrollHeight') + 30 );
	};
});
