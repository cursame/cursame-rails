
<div id="chat-channel-<%= channel.id%>" class="chat-panel active" data-panel-id="<%= channel.id%>">
	<div class="chat-panel-header">
		<h6><%= truncate(get_chat_title(channel), :omission => "...", :length => 35) %></h6>
		<div class="chat-panel-actions">
			<div class="chat-panel-action">
				<a href="" id="close-chat-<%= channel.id%>" title="Cerrar"><%= icon('w-cross-9') %></a>
			</div>
		</div>
	</div>
	<div class="chat-panel-main">
		<div id="chat-zone-<%= channel.id%>" class="chat-zone">
			<div class="chat-panel-main-content">
				<% unless messages.empty? %>
					<div class="load-more-messages" id="load-more-messages-<%= channel.id%>">
						<%=render(:partial => '/shared/chat/load_more_messages', :locals => {:channel => channel, :page => page + 1})%>
					</div>
				<% end %>

				<div class="chat-zone-messages chat-messages-container" id="chat-zone-messages-channel<%= channel.id%>">
					<%= render(:partial => '/shared/chat/messages', :locals => {:messages => messages, :on_panel => "hola" })%>
				</div>
			</div>
			
			<div class="chat-zone-footer">
				<%= render :partial => "shared/chat/add_message_form", :locals => { :channel_name => channel.channel_name, :channel_id => channel.id } %>
			</div>
		</div>
	</div>
</div>

<script>

	$("#chat-channel-<%= channel.id%> .chat-panel-header").click(function () {
		var panel = $(this).closest('.chat-panel');

		panel.toggleClass('active');
	});

	// cerramos el chat
	$("#close-chat-<%= channel.id%>").click(function (e) {
		e.preventDefault();
		
		// Obtenemos la posicion del panel que se borrara
		var lastChatLocation = $("#chat-channel-<%= channel.id%>").position();

		$("#chat-channel-<%= channel.id%>").remove();
		PrivatePub.unsubscribe("<%=channel.channel_name%>");
		Chat.panelCount--;

		// Se recorren los otros paneles a la derecha
		var chatPanels = $(".chat-panel");
		for (var i = 0; i < chatPanels.length; i++) {
			var currChatLocation = $(chatPanels[i]).position();

			// Si el panel actual esta a la derecha entonces hay que recorrerlo
			if(currChatLocation.left < lastChatLocation.left) {
				$(chatPanels[i]).css({
					'left': lastChatLocation.left
				});

				lastChatLocation = currChatLocation;
			}
		};

		// Checamos si hay canales que no se pudieron abrir
		if($("#go-to-chats-url").length) {

			// Obtenemos los canales que estaba pendientes
			var pendingChatsIds = $("#go-to-chats-url").attr('pendingChats').split(' ');

			// Abrimos el ultimo canal que no se pudo abrir
			var pendingChatInfo = pendingChatsIds[pendingChatsIds.length - 1].split("/")[2].split("_");
			var urlPendingChat = "/home/open_channel/" + pendingChatInfo[pendingChatInfo.length - 1];

			// Si el ultimo chat es de un curso
			if(pendingChatInfo.length == 3) {
				urlPendingChat = urlPendingChat + "?course=true";
			}

			pendingChatsIds.pop();

			var newPendingChats = '';
			for (var i = 0; i < pendingChatsIds.length; i++) {
				newPendingChats = newPendingChats + pendingChatsIds[i];
			};
			$("#go-to-chats-url").attr('pendingChats', newPendingChats);

			$.get(urlPendingChat, function() {
				window.pendingChatsCount--;

				// Si ya no hay chats pendientes entonces quitamos el cuadro de 'ver mas'
				if(window.pendingChatsCount == 0) {
					$("#go-to-chats-url").remove();
				}
			});
		}

		Chat.reOrder();
	});
	
	$('.chat-panel').mouseenter( function() {
		$(this).find('.closeChat').show();
	});
	$('.chat-panel').mouseleave( function() {
		$(this).find('.closeChat').hide();
	});
	
</script>
